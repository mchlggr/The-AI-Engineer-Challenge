# Investigation: Local `POST /api/chat/stream` returns 404

## Summary
Local streaming chat requests were sent to the Next.js dev server (`localhost:3001`) but the app had no `/api/*` routes or proxy configured, so Next returned `404` instead of forwarding to the FastAPI backend.

## Symptoms
- UI error: `Sorry, there was an error: Stream request failed with status 404`
- Network: `POST http://localhost:3001/api/chat/stream` (JSON body includes `session_id` + `message`)

## Investigation Log

### 2026-01-09 — Phase 1: Initial Assessment
**Hypothesis:** Next is receiving `/api/chat/stream` and returning 404 because it isn't proxying to FastAPI.  
**Findings:** The frontend always uses same-origin URLs in the browser, so `:3001` receives the `/api/*` request.  
**Evidence:** `frontend/src/lib/api.ts:134` (`getBaseUrl()` returns `""` in the browser, forcing same-origin `/api/...`).  
**Conclusion:** Strongly supports missing-proxy hypothesis.

### 2026-01-09 — Phase 2: Route/Ownership Mapping
**Hypothesis:** The FastAPI backend defines `/api/chat/stream`, but local requests never reach it.  
**Findings:** The FastAPI app in `api/index.py` defines `POST /api/chat/stream`, but Next had no rewrites configured.  
**Evidence:**
- `api/index.py:107` (`@app.post("/api/chat/stream")`)
- `frontend/next.config.ts:1` (was an empty config with no `rewrites()` before the fix)
**Conclusion:** Confirmed — local routing glue was missing.

### 2026-01-09 — Phase 3: Repro Attempt (Sandbox Limitation)
**Hypothesis:** Starting `next dev` and hitting `/api/chat/stream` reproduces 404.  
**Findings:** The sandbox environment blocks binding to local ports (Next fails with `listen EPERM`).  
**Evidence:** `npm run dev` fails with `listen EPERM: operation not permitted ...:3001` in this environment.  
**Conclusion:** Runtime repro blocked here; proceed based on static evidence + fix.

## Root Cause
1. The browser-side API client intentionally uses same-origin paths (e.g. `fetch("/api/chat/stream", ...)`). (`frontend/src/lib/api.ts:134`)
2. The Next.js dev server had no `/api/*` routes or rewrite proxy configured, so it handled the request directly and returned `404`. (`frontend/next.config.ts` before fix)
3. The intended backend endpoint exists in FastAPI (`api/index.py:107`), but local requests never reached it.

## Recommendations
1. Add a dev proxy in `frontend/next.config.ts` that rewrites `/api/:path*` → FastAPI (default `http://127.0.0.1:8000`). (Implemented)
2. Document `API_PROXY_TARGET` in `frontend/.env.local.example` and frontend docs so local dev setup is obvious. (Implemented)
3. Improve the UI error message when a 404 occurs to hint “API not running / proxy missing”. (Implemented)

## Preventive Measures
- Keep local dev topology documented: Next (`:3000`/`:3001`) + FastAPI (`:8000`) + `/api/*` proxy.
- Consider a lightweight check in CI (or a doc “smoke check”) that validates Next config includes the dev `/api/*` proxy while preventing accidental `localhost` proxying in production builds.

